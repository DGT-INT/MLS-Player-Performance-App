---
title: "02 Cleaning"
author: "Daniel Tshiani"
date: "2025-10-20"
output: html_document
---

```{r}
library(tidyverse)
```


```{r}
master_data <- readRDS("../data/01 preprocessed data.rds")
```

# Correcting data types, Encode categorical variables & scaling necessary when
```{r}
glimpse(master_data)
```
```{r}
master_data <- master_data %>%
  mutate(position = as.factor(position),
         competition = as.factor(competition),
         birth_date = ymd(birth_date),
         age = year(today()) - year(birth_date) - (yday(today()) < yday(birth_date)),
         age = as.integer(age)
         ) %>%
  relocate(age, .after = birth_date) %>%
  mutate(homegrown = ifelse(nationality %in% c("USA", "Canada"), "Domestic", "Foreign")) %>%
  mutate(homegrown = as.factor(homegrown)) %>%
  relocate (homegrown, .after = nationality) %>%
  mutate(height_inches = height_ft * 12 + height_in,
         height_inches = as.integer(height_inches)) %>%
  relocate(height_inches, .after = height_in) %>%
  relocate(competitions, .after = competition) %>% # I need to look into this more closely but competition will be prioritized due to it being a single character vs a list
  relocate(team_competitions, .after = competitions) %>% # need to look into this more closely
  relocate(general_position, .after = position) %>%
  mutate(pass_completion_percentage = 100 * pass_completion_percentage,
         xpass_completion_percentage = 100 * xpass_completion_percentage,
         share_team_touches = 100 * share_team_touches)
  
glimpse(master_data)
```

# Checking and Removing duplicates
```{r}
sum(duplicated(master_data)) # no duplicates across all rows
sum(duplicated(master_data[, c("player_id", "team_id.x", "season_name")])) # 339 duplicates across these 3 variables

duplicates <- master_data %>%
  group_by(player_id, team_id.x, season_name) %>%
  mutate(count = n()) %>%
  filter(n() > 1) %>%   
  ungroup() %>%
  arrange(player_id, team_id.x, season_name)

table(duplicates$team_id.x) # the duplicates are because they are missing the duplicates$team_id.x variable
# looks like one of the previous datasets didnt merge properly. they are all missing team_id.x so i will use team_id.y for these observations

sum(duplicated(duplicates[, c("player_id", "team_id.y", "season_name")])) # when i use the team_id.y variable they are unique
```

```{r}
# to find where the merge is going wrong i need to go back and create flags for each dataset before merging but for the sake of time i will continue to move forward by replacing the missing team_id.x with team_id.y and seeing what i can salvage

class(duplicates$team_id.y) # its a list
max(sapply(duplicates$team_id.y, length)) # max number of elements is 1 so shouldnt cause any big issues

missing_playerID <- unique(duplicates$player_id)

max(sapply(master_data$team_id.y, length))

master_data <- master_data %>%
  mutate(team_id.y2 = map(team_id.y, ~ if (length(.x) == 1) .x else NULL))
max(sapply(master_data$team_id.y2, length)) 

master_data <- master_data %>%
  mutate(team_id.x = ifelse(is.na(team_id.x), team_id.y2, team_id.x)) %>%
  select(-team_id.y2)
```

```{r}
# now that i replaced the missing team_id.x with team_id.y, i will try again to Check and Remove duplicates
sum(duplicated(master_data[, c("player_id", "team_id.x", "season_name")])) # now i dropped from 339 to 44 duplicates across these 3 variables

duplicates <- master_data %>%
  group_by(player_id, team_id.x, season_name) %>%
  mutate(count = n()) %>%
  filter(n() > 1) %>%   
  ungroup() %>%
  arrange(player_id, team_id.x, season_name)

sum(duplicated(duplicates[, c("player_id", "team_id.y", "season_name")])) 

# I did a visual inspection and looks like these are genuine duplicates. however for each pair, 1 of them is missing team name and related information so i will keep the more complete row in the master_data

master_data <- master_data %>%
  arrange(player_id, season_name, team_id.x, team_name) %>%
  distinct(player_id, season_name, team_id.x, .keep_all = TRUE)
```

# Inspecting & handling missing values
```{r}
library(visdat)
vis_miss(master_data, warn_large_data = FALSE)
```
There is alot of data missing. I dont want to drop players from the final app so i will have 1 dataset for the app will all the data possible, and another cleaner version of the data that will be use to train and test the models

## I want to see how missingsness looks by competition

```{r}
mls <- master_data %>%
  filter(competition == "mls")
vis_miss(mls)
```
```{r}
mlsnp <- master_data %>%
  filter(competition == "mlsnp")
vis_miss(mlsnp)
```
So i dont have any salary data for MLSNP. This is an issue. I am asuming other leagues will be missing salary too but for the purpose of using this project to diplay my soccer analytics abilities i will continue.

```{r}
nasl <- master_data %>%
  filter(competition == "nasl")
vis_miss(nasl)
```


```{r}
nwsl <- master_data %>%
  filter(competition == "nwsl")
vis_miss(nwsl)
```


```{r}
usl1 <- master_data %>%
  filter(competition == "usl1")
vis_miss(usl1)
```


```{r}
table(master_data$competition)
```


```{r}
app_data <- master_data # data for the deployment

test <- master_data %>%
  mutate(general_position = ifelse(is.na(general_position), position, general_position)) %>%
  select(-position)

vis_miss(test, warn_large_data = FALSE)
```






# Initial Preprocessing Completed
ðŸ’¡ Summary workflow after merging your dataframe:

Identify & handle outliers
Feature engineering
Split train/test
Explore correlations & distributions
Save cleaned dataset + preprocessing pipeline



# to be deleted
```{r}

master_data <- master_data 

master_data <- master_data 
  
glimpse(master_data)
rm(players_data)
```

```{r}
# joining player expected goals data
glimpse(player_xgoals_data)
sum(is.na(player_xgoals_data$player_id))
```
```{r}
unmatched <- bind_rows(
  anti_join(master_data, player_xgoals_data, by = "player_id"),
  anti_join(player_xgoals_data, master_data, by = "player_id")
)
```


```{r}
master_data1 <- left_join(master_data, player_xgoals_data, by = "player_id")
glimpse(master_data1)
```




# 0ld
```{r}
players <- data$get_players()
players2 <- data$players

teams <- data$get_teams()
teams2 <- data$teams

leagues <- data$LEAGUES

player_salary <- data$get_player_salaries()
team_salary <- data$get_team_salaries()


```

```{r}
player_data <- left_join(player_salary, players2, by = "player_id") # joining player and salary data at the season/salary level

player_data <- left_join(player_data, teams2, by = "team_id") # adding team names to the data
```

```{r}
team_salary <- team_salary %>%
  select(-count_players, -std_dev_guaranteed_compensation) %>%
  rename(team_guaranteed_compensation = total_guaranteed_compensation,
         team_avg_gauranteed_compenesation = avg_guaranteed_compensation,
         team_median_guaranteed_compensation = median_guaranteed_compensation,
         team_competition = competition)

player_data <- left_join(player_data, team_salary, by = "team_id") # adding team salary data
```

```{r}
str(data)
```

```{r}
goals <- data$get_player_xgoals(season_name = 2024)
goals_added <- data$get_player_goals_added()
pass <- data$get_player_xpass(split_by_seasons = TRUE)
```

# Focusing on dat for Offensive tab

```{r}
offensive_data <- data$get_player_xgoals(season_name = 2024)
player_data <- data$players
player_data <- player_data %>%
  select(-competitions)

offensive_data <- left_join(offensive_data, player_data, by = "player_id")
offensive_data <- offensive_data %>%
  relocate(player_name, birth_date, general_position, nationality, player_id, team_id)

team_data <- data$teams

offensive_data <- offensive_data %>%
  mutate(team_id = sapply(team_id, function(x) as.character(x[1])))

offensive_data <- left_join(offensive_data, team_data, by = "team_id")
offensive_data <- offensive_data %>% select(-team_short_name, -team_abbreviation)

offensive_data <- offensive_data %>%
  relocate(player_name, team_name, birth_date, general_position, nationality, player_id, team_id)
```


```{r}
offensive_data <- offensive_data %>%
  mutate(
    birth_date = ymd(birth_date),      # convert to Date format if not already
    age = as.integer(floor(interval(birth_date, today()) / years(1)))
  ) %>%
    relocate(player_name, team_name, age, birth_date, general_position, nationality)
```

```{r}
# Adding salary of offensive data
salary_data <- data$get_player_salaries(season_name = 2024)

# getting rid of duplicates player_id and team_id combo
salary_data <- salary_data %>%
  arrange(desc(mlspa_release)) %>%
  distinct(player_id, team_id, .keep_all = TRUE)

offensive_data <- left_join(offensive_data, salary_data, by = c("player_id", "team_id"))
```


```{r}
#saveRDS(offensive_data, file = "../data/offensive_data.rds")
```


