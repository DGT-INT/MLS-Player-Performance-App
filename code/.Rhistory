for (year in 2013:2025) {
var_name <- paste0("player_xpass_data_", year)
temp <- data$get_player_xpass(season_name = as.character(year)) %>%
mutate(season_name = year)
assign(var_name, temp)
}
#now i can run a loop to do a full join by player_id and season_name; and then clean up the environment
player_xpass_all <- bind_rows(
lapply(2013:2025, function(year) get(paste0("player_xpass_data_", year)))
)
rm(list = paste0("player_xpass_data_", 2013:2025), player_xpass_data)
test <- full_join(master_data, player_xpass_all, by= c("player_id", "season_name", "competition"))
test <- test%>%
mutate(match = ifelse(team_id.x == team_id.y, 1, 0))
table(test$match) # I viewed the data and team_id.y is a list so i will prioritize team_id.x first
rm(test)
master_data <- full_join(master_data, player_xpass_all, by= c("player_id", "season_name", "competition"))
rm(player_xpass_all, temp)
glimpse(player_xgoals_data)
glimpse(master_data)
for (year in 2013:2025) {
var_name <- paste0("player_xgoals_data_", year)
temp <- data$get_player_xgoals(season_name = as.character(year)) %>%
mutate(season_name = year)
assign(var_name, temp)
}
#now i can run a loop to do a full join by player_id and season_name; and then clean up the environment
player_xgoals_all <- bind_rows(
lapply(2013:2025, function(year) get(paste0("player_xgoals_data_", year)))
)
rm(list = paste0("player_xgoals_data_", 2013:2025), player_xgoals_data)
master_data <- full_join(master_data, player_xgoals_all, by= c("player_id", "season_name", "competition"))
rm(test)
rm(player_xgoals_all, temp, data)
glimpse(master_data)
library(tidyverse)
master_data <- readRDS("../data/01 preprocessed data.rds")
glimpse(master_data)
master_data <- master_data %>%
mutate(position = as.factor(position),
competition = as.factor(competition),
birth_date = ymd(birth_date),
age = year(today()) - year(birth_date) - (yday(today()) < yday(birth_date)),
age = as.integer(age)
) %>%
relocate(age, .after = birth_date) %>%
mutate(homegrown = ifelse(nationality %in% c("USA", "Canada"), "Domestic", "Foreign")) %>%
mutate(homegrown = as.factor(homegrown)) %>%
relocate (homegrown, .after = nationality) %>%
mutate(height_inches = height_ft * 12 + height_in,
height_inches = as.integer(height_inches)) %>%
relocate(height_inches, .after = height_in) %>%
relocate(competitions, .after = competition) %>% # I need to look into this more closely but competition will be prioritized due to it being a single character vs a list
relocate(team_competitions, .after = competitions) %>% # need to look into this more closely
relocate(general_position.x, .after = position) %>%
relocate(general_position.y, .after = general_position.x) %>%
mutate(pass_completion_percentage = 100 * pass_completion_percentage,
xpass_completion_percentage = 100 * xpass_completion_percentage,
share_team_touches = 100 * share_team_touches)
glimpse(master_data)
sum(duplicated(master_data)) # no duplicates across all rows
library(tidyverse)
master_data <- readRDS("../data/01 preprocessed data.rds")
glimpse(master_data)
master_data <- master_data %>%
mutate(position = as.factor(position),
competition = as.factor(competition),
birth_date = ymd(birth_date),
age = year(today()) - year(birth_date) - (yday(today()) < yday(birth_date)),
age = as.integer(age)
) %>%
relocate(age, .after = birth_date) %>%
mutate(homegrown = ifelse(nationality %in% c("USA", "Canada"), "Domestic", "Foreign")) %>%
mutate(homegrown = as.factor(homegrown)) %>%
relocate (homegrown, .after = nationality) %>%
mutate(height_inches = height_ft * 12 + height_in,
height_inches = as.integer(height_inches)) %>%
relocate(height_inches, .after = height_in) %>%
relocate(competitions, .after = competition) %>% # I need to look into this more closely but competition will be prioritized due to it being a single character vs a list
relocate(team_competitions, .after = competitions) %>% # need to look into this more closely
relocate(general_position.x, .after = position) %>%
relocate(general_position.y, .after = general_position.x) %>%
mutate(pass_completion_percentage = 100 * pass_completion_percentage,
xpass_completion_percentage = 100 * xpass_completion_percentage,
share_team_touches = 100 * share_team_touches)
glimpse(master_data)
sum(duplicated(master_data)) # no duplicates across all rows
#sum(duplicated(master_data)) # no duplicates across all rows
sum(duplicated(master_data[, c("player_id", "team_id.x", "season_name")])) # 339 duplicates across these 3 variables
duplicates <- master_data %>%
group_by(player_id, team_id.x, season_name) %>%
mutate(count = n()) %>%
filter(n() > 1) %>%
ungroup() %>%
arrange(player_id, team_id.x, season_name)
table(duplicates$team_id.x) # the duplicates are because they are missing the duplicates$team_id.x variable
# looks like one of the previous datasets didnt merge properly. they are all missing team_id.x so i will use team_id.y for these observations
sum(duplicated(duplicates[, c("player_id", "team_id.y", "season_name")])) # when i use the team_id.y variable they are unique
# to find where the merge is going wrong i need to go back and create flags for each dataset before merging but for the sake of time i will continue to move forward by replacing the missing team_id.x with team_id.y and seeing what i can salvage
class(duplicates$team_id.y) # its a list
max(sapply(duplicates$team_id.y, length)) # max number of elements is 1 so shouldnt cause any big issues
missing_playerID <- unique(duplicates$player_id)
max(sapply(master_data$team_id.y, length))
master_data <- master_data %>%
mutate(team_id.y2 = map(team_id.y, ~ if (length(.x) == 1) .x else NULL))
max(sapply(master_data$team_id.y2, length))
master_data <- master_data %>%
mutate(team_id.x = ifelse(is.na(team_id.x), team_id.y2, team_id.x)) %>%
select(-team_id.y2)
# now that i replaced the missing team_id.x with team_id.y, i will try again to Check and Remove duplicates
sum(duplicated(master_data[, c("player_id", "team_id.x", "season_name")])) # now i dropped from 339 to 44 duplicates across these 3 variables
library(tidyverse)
master_data <- readRDS("../data/01 preprocessed data.rds")
glimpse(master_data)
master_data <- master_data %>%
mutate(position = as.factor(position),
competition = as.factor(competition),
birth_date = ymd(birth_date),
age = year(today()) - year(birth_date) - (yday(today()) < yday(birth_date)),
age = as.integer(age)
) %>%
relocate(age, .after = birth_date) %>%
mutate(homegrown = ifelse(nationality %in% c("USA", "Canada"), "Domestic", "Foreign")) %>%
mutate(homegrown = as.factor(homegrown)) %>%
relocate (homegrown, .after = nationality) %>%
mutate(height_inches = height_ft * 12 + height_in,
height_inches = as.integer(height_inches)) %>%
relocate(height_inches, .after = height_in) %>%
relocate(competitions, .after = competition) %>% # I need to look into this more closely but competition will be prioritized due to it being a single character vs a list
relocate(team_competitions, .after = competitions) %>% # need to look into this more closely
relocate(general_position.x, .after = position) %>%
relocate(general_position.y, .after = general_position.x) %>%
mutate(pass_completion_percentage = 100 * pass_completion_percentage,
xpass_completion_percentage = 100 * xpass_completion_percentage,
share_team_touches = 100 * share_team_touches)
glimpse(master_data)
sum(duplicated(master_data)) # no duplicates across all rows
sapply(master_data, class)
# sum(duplicated(master_data)) # no duplicates across all rows, in an update the competition variables became lists
sum(duplicated(master_data[, c("player_id", "team_id.x", "season_name")])) # 339 duplicates across these 3 variables
duplicates <- master_data %>%
group_by(player_id, team_id.x, season_name) %>%
mutate(count = n()) %>%
filter(n() > 1) %>%
ungroup() %>%
arrange(player_id, team_id.x, season_name)
table(duplicates$team_id.x) # the duplicates are because they are missing the duplicates$team_id.x variable
# looks like one of the previous datasets didnt merge properly. they are all missing team_id.x so i will use team_id.y for these observations
sum(duplicated(duplicates[, c("player_id", "team_id.y", "season_name")])) # when i use the team_id.y variable they are unique
# to find where the merge is going wrong i need to go back and create flags for each dataset before merging but for the sake of time i will continue to move forward by replacing the missing team_id.x with team_id.y and seeing what i can salvage
class(duplicates$team_id.y) # its a list
max(sapply(duplicates$team_id.y, length)) # max number of elements is 1 so shouldnt cause any big issues
missing_playerID <- unique(duplicates$player_id)
max(sapply(master_data$team_id.y, length))
master_data <- master_data %>%
mutate(team_id.y2 = map(team_id.y, ~ if (length(.x) == 1) .x else NULL))
max(sapply(master_data$team_id.y2, length))
master_data <- master_data %>%
mutate(team_id.x = ifelse(is.na(team_id.x), team_id.y2, team_id.x)) %>%
select(-team_id.y2)
# now that i replaced the missing team_id.x with team_id.y, i will try again to Check and Remove duplicates
sum(duplicated(master_data[, c("player_id", "team_id.x", "season_name")])) # now i dropped from 339 to 44 duplicates across these 3 variables
# now that i replaced the missing team_id.x with team_id.y, i will try again to Check and Remove duplicates
#sum(duplicated(master_data[, c("player_id", "team_id.x", "season_name")])) # now i dropped from 339 to 44 duplicates across these 3 variables. again variables were updated to list
duplicates <- master_data %>%
group_by(player_id, team_id.x, season_name) %>%
mutate(count = n()) %>%
filter(n() > 1) %>%
ungroup() %>%
arrange(player_id, team_id.x, season_name)
sum(duplicated(duplicates[, c("player_id", "team_id.y", "season_name")]))
# I did a visual inspection and looks like these are genuine duplicates. however for each pair, 1 of them is missing team name and related information so i will keep the more complete row in the master_data
master_data <- master_data %>%
arrange(player_id, season_name, team_id.x, team_name) %>%
distinct(player_id, season_name, team_id.x, .keep_all = TRUE)
library(visdat)
vis_miss(master_data, warn_large_data = FALSE)
mls <- master_data %>%
filter(competition == "mls")
vis_miss(mls)
mlsnp <- master_data %>%
filter(competition == "mlsnp")
vis_miss(mlsnp)
nasl <- master_data %>%
filter(competition == "nasl")
vis_miss(nasl)
nwsl <- master_data %>%
filter(competition == "nwsl")
vis_miss(nwsl)
usl1 <- master_data %>%
filter(competition == "usl1")
vis_miss(usl1)
table(master_data$competition)
app_deployment_data <- master_data # data for the deployment
working_data <- master_data
rm(duplicates, master_data, mls, mlsnp, nasl, nwsl, usl1, missing_playerID)
working_data %>%
summarise(
pct_missing_base_salary = mean(is.na(base_salary)) * 100
)
working_data %>%
group_by(competition) %>%
summarise(
pct_missing_base_salary = mean(is.na(base_salary)) * 100
)
working_data <- working_data %>%
filter(!is.na(base_salary))
vis_miss(working_data)
# Now that the missingness througout the dataset is 10%, i will loop through it and replace the missing values with mean or mode depending on the type of variable.
# Function to get the mode
get_mode <- function(x) {
ux <- na.omit(unique(x))
ux[which.max(tabulate(match(x, ux)))]
}
working_data <- working_data %>%
# Drop rows with missing player_id
filter(!is.na(player_id)) %>%
# Replace missing team_id variants with "Free Agent"
mutate(across(
c(team_id.x, team_id.y, team_id),
~ replace(.x, is.na(.x) | .x == "", "Free Agent")
)) %>%
# Replace other missing values
mutate(across(
# skip id columns and team columns we already handled
-c(player_id, team_id.x, team_id.y, team_id),
~ if (is.numeric(.x)) {
replace(.x, is.na(.x), mean(.x, na.rm = TRUE))
} else {
replace(.x, is.na(.x), get_mode(.x))
}
))
vis_miss(working_data)
ggplot(working_data, aes(x = base_salary)) +
geom_histogram(binwidth = 100, fill = "skyblue", color = "black") +
labs(
title = "Distribution of Base Salary",
x = "Base Salary",
y = "Count"
) +
theme_minimal()
# Find Messi's salary
messi_salary <- working_data %>%
filter(player_name == "Lionel Messi", season_name == 2025) %>%
pull(base_salary)
# Plot
ggplot(working_data, aes(x = base_salary)) +
geom_histogram(binwidth = 100, fill = "skyblue", color = "black") +
geom_vline(aes(xintercept = messi_salary),
color = "red", linewidth = 1.2, linetype = "dashed") +
annotate("text", x = messi_salary, y = Inf, vjust = 2, hjust = 0,
label = "Messi", color = "red", fontface = "bold") +
labs(
title = "Distribution of Base Salary",
x = "Base Salary",
y = "Count"
) +
theme_minimal()
glimpse(working_data)
library(tidyverse)
master_data <- readRDS("../data/01 preprocessed data.rds")
glimpse(master_data)
master_data <- master_data %>%
mutate(position = as.factor(position),
competition = as.factor(competition),
birth_date = ymd(birth_date),
age = year(today()) - year(birth_date) - (yday(today()) < yday(birth_date)),
age = as.integer(age)
) %>%
relocate(age, .after = birth_date) %>%
mutate(homegrown = ifelse(nationality %in% c("USA", "Canada"), "Domestic", "Foreign")) %>%
mutate(homegrown = as.factor(homegrown)) %>%
relocate (homegrown, .after = nationality) %>%
mutate(height_inches = height_ft * 12 + height_in,
height_inches = as.integer(height_inches)) %>%
relocate(height_inches, .after = height_in) %>%
relocate(competitions, .after = competition) %>% # I need to look into this more closely but competition will be prioritized due to it being a single character vs a list
relocate(team_competitions, .after = competitions) %>% # need to look into this more closely
relocate(general_position.x, .after = position) %>%
relocate(general_position.y, .after = general_position.x) %>%
mutate(pass_completion_percentage = 100 * pass_completion_percentage,
xpass_completion_percentage = 100 * xpass_completion_percentage,
share_team_touches = 100 * share_team_touches)
glimpse(master_data)
# sum(duplicated(master_data)) # no duplicates across all rows, in an update the competition variables became lists
sum(duplicated(master_data[, c("player_id", "team_id.x", "season_name")])) # 339 duplicates across these 3 variables
duplicates <- master_data %>%
group_by(player_id, team_id.x, season_name) %>%
mutate(count = n()) %>%
filter(n() > 1) %>%
ungroup() %>%
arrange(player_id, team_id.x, season_name)
table(duplicates$team_id.x) # the duplicates are because they are missing the duplicates$team_id.x variable
# looks like one of the previous datasets didnt merge properly. they are all missing team_id.x so i will use team_id.y for these observations
sum(duplicated(duplicates[, c("player_id", "team_id.y", "season_name")])) # when i use the team_id.y variable they are unique
# to find where the merge is going wrong i need to go back and create flags for each dataset before merging but for the sake of time i will continue to move forward by replacing the missing team_id.x with team_id.y and seeing what i can salvage
class(duplicates$team_id.y) # its a list
max(sapply(duplicates$team_id.y, length)) # max number of elements is 1 so shouldnt cause any big issues
missing_playerID <- unique(duplicates$player_id)
max(sapply(master_data$team_id.y, length))
master_data <- master_data %>%
mutate(team_id.y2 = map(team_id.y, ~ if (length(.x) == 1) .x else NULL))
max(sapply(master_data$team_id.y2, length))
master_data <- master_data %>%
mutate(team_id.x = ifelse(is.na(team_id.x), team_id.y2, team_id.x)) %>%
select(-team_id.y2)
# now that i replaced the missing team_id.x with team_id.y, i will try again to Check and Remove duplicates
#sum(duplicated(master_data[, c("player_id", "team_id.x", "season_name")])) # now i dropped from 339 to 44 duplicates across these 3 variables. again variables were updated to list
duplicates <- master_data %>%
group_by(player_id, team_id.x, season_name) %>%
mutate(count = n()) %>%
filter(n() > 1) %>%
ungroup() %>%
arrange(player_id, team_id.x, season_name)
sum(duplicated(duplicates[, c("player_id", "team_id.y", "season_name")]))
# I did a visual inspection and looks like these are genuine duplicates. however for each pair, 1 of them is missing team name and related information so i will keep the more complete row in the master_data
master_data <- master_data %>%
arrange(player_id, season_name, team_id.x, team_name) %>%
distinct(player_id, season_name, team_id.x, .keep_all = TRUE)
library(visdat)
vis_miss(master_data, warn_large_data = FALSE)
mls <- master_data %>%
filter(competition == "mls")
vis_miss(mls)
mlsnp <- master_data %>%
filter(competition == "mlsnp")
vis_miss(mlsnp)
nasl <- master_data %>%
filter(competition == "nasl")
vis_miss(nasl)
nwsl <- master_data %>%
filter(competition == "nwsl")
vis_miss(nwsl)
usl1 <- master_data %>%
filter(competition == "usl1")
vis_miss(usl1)
table(master_data$competition)
app_deployment_data <- master_data # data for the deployment
working_data <- master_data # data for modeling
rm(duplicates, master_data, mls, mlsnp, nasl, nwsl, usl1, missing_playerID)
working_data %>%
summarise(
pct_missing_base_salary = mean(is.na(base_salary)) * 100
)
working_data %>%
group_by(competition) %>%
summarise(
pct_missing_base_salary = mean(is.na(base_salary)) * 100
)
working_data <- working_data %>%
filter(!is.na(base_salary))
vis_miss(working_data)
# Now that the missingness througout the dataset is 10%, i will loop through it and replace the missing values with mean or mode depending on the type of variable.
# Function to get the mode
get_mode <- function(x) {
ux <- na.omit(unique(x))
ux[which.max(tabulate(match(x, ux)))]
}
working_data <- working_data %>%
# Drop rows with missing player_id
filter(!is.na(player_id)) %>%
# Replace missing team_id variants with "Free Agent"
mutate(across(
c(team_id.x, team_id.y, team_id),
~ replace(.x, is.na(.x) | .x == "", "Free Agent")
)) %>%
# Replace other missing values
mutate(across(
# skip id columns and team columns we already handled
-c(player_id, team_id.x, team_id.y, team_id),
~ if (is.numeric(.x)) {
replace(.x, is.na(.x), mean(.x, na.rm = TRUE))
} else {
replace(.x, is.na(.x), get_mode(.x))
}
))
vis_miss(working_data)
ggplot(working_data, aes(x = base_salary)) +
geom_histogram(binwidth = 100, fill = "skyblue", color = "black") +
labs(
title = "Distribution of Base Salary",
x = "Base Salary",
y = "Count"
) +
theme_minimal()
# Find Messi's salary
messi_salary <- working_data %>%
filter(player_name == "Lionel Messi", season_name == 2025) %>%
pull(base_salary)
# Plot
ggplot(working_data, aes(x = base_salary)) +
geom_histogram(binwidth = 100, fill = "skyblue", color = "black") +
geom_vline(aes(xintercept = messi_salary),
color = "red", linewidth = 1.2, linetype = "dashed") +
annotate("text", x = messi_salary, y = Inf, vjust = 2, hjust = 0,
label = "Messi", color = "red", fontface = "bold") +
labs(
title = "Distribution of Base Salary",
x = "Base Salary",
y = "Count"
) +
theme_minimal()
glimpse(working_data)
help("rename")
working_data2 <- working_data %>%
select(-player_id, -team_id.x) %>%
rename(season = season_name,
"general position" = position,
position = general_position.x) %>%
select(-general_position.y, -competitions)
glimpse(working_data2)
working_data2 <- working_data %>%
select(-player_id, -team_id.x) %>%
rename(season = season_name,
"general position" = position,
position = general_position.x,
"base salary" = base_salary,
"gauranteed compensation" = gauranteed_compensation) %>%
select(-general_position.y, -competitions)
working_data2 <- working_data %>%
select(-player_id, -team_id.x) %>%
rename(season = season_name,
"general position" = position,
position = general_position.x,
"base salary" = base_salary,
"gauranteed compensation" = guaranteed_compensation) %>%
select(-general_position.y, -competitions)
glimpse(working_data2)
help("is.factor")
working_data2 <- working_data %>%
select(-player_id, -team_id.x) %>%
rename(season = season_name,
"general position" = position,
position = general_position.x,
"base salary" = base_salary,
"gauranteed compensation" = guaranteed_compensation) %>%
select(-general_position.y, -competitions) %>%
as.factor(position)
help("as.factor")
working_data2 <- working_data %>%
select(-player_id, -team_id.x) %>%
rename(season = season_name,
"general position" = position,
position = general_position.x,
"base salary" = base_salary,
"gauranteed compensation" = guaranteed_compensation) %>%
select(-general_position.y, -competitions) %>%
as.factor(position)
working_data2 <- working_data %>%
select(-player_id, -team_id.x) %>%
rename(season = season_name,
"general position" = position,
position = general_position.x,
"base salary" = base_salary,
"gauranteed compensation" = guaranteed_compensation) %>%
select(-general_position.y, -competitions) %>%
as.factor(position)
working_data2 <- working_data %>%
select(-player_id, -team_id.x) %>%
rename(season = season_name,
"general position" = position,
position = general_position.x,
"base salary" = base_salary,
"gauranteed compensation" = guaranteed_compensation) %>%
select(-general_position.y, -competitions) %>%
mutate( position = as.factor(position))
glimpse(working_data2)
working_data2 <- working_data %>%
select(-player_id, -team_id.x) %>%
rename(season = season_name,
"general position" = position,
position = general_position.x,
"base salary" = base_salary,
"gauranteed compensation" = guaranteed_compensation) %>%
select(-general_position.y, -competitions) %>%
mutate( position = as.factor(position)) %>%
select(-team_competitions) %>%
rename("player name" = player_name,
"date of birth" = birth_date,
"height (ft)" = height_ft,
"height (in" = height_in,
weight = weight_lb) %>%
select(-height_inches)
glimpse(working_data2)
# pick up from team_name
working_data2 <- working_data %>%
select(-player_id, -team_id.x) %>%
rename(season = season_name,
"general position" = position,
position = general_position.x,
"base salary" = base_salary,
"gauranteed compensation" = guaranteed_compensation) %>%
select(-general_position.y, -competitions) %>%
mutate( position = as.factor(position)) %>%
select(-team_competitions) %>%
rename("player name" = player_name,
"date of birth" = birth_date,
"height (ft)" = height_ft,
"height (in)" = height_in,
weight = weight_lb) %>%
select(-height_inches) %>%
rename("team name" = team_name) %>%
select(-team_short_name, - team_abbreviation, -team_id.y) %>%
rename("minutes played" = minutes_played.x,
"attempted passes" = attempted_passes,
"pass completion percentage" = pass_completion_percentage,
"expected pass completion percentage" = xpass_completion_percentage,
"pass completed over expected" = passes_completed_over_expected,
"pass completed over expected p100" = passes_completed_over_expected_p100,
"average distance (yards)" = avg_distance_yds)
glimpse(working_data2)
# pick up from avg_distance_yds
